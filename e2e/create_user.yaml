desc: CreateUser
runners:
  greq: grpc://server:8080
steps:
  - desc: ユーザーが作成できる
    greq:
      twitter.TwitterService/CreateUser:
        message: {"screen_name":"screen_name", "user_name":"user_name", "bio":"bio"}
    test: |
      len(current.res.message.id) == 36
      && current.res.status == 0
      && current.res.headers["content-type"][0] == "application/grpc"

  - desc: 作成したユーザーをFindUserByScreenNameで取得できることを確認
    greq:
      twitter.TwitterService/FindUserByScreenName:
        message: {"screen_name":"screen_name"}
    test: |
      current.res.message.screen_name == "screen_name"
      && current.res.message.user_name == "user_name"
      && current.res.message.bio == "bio"
      && current.res.status == 0

  - desc: user.New()のバリデーションに違反するパラメータを指定するとエラーが返る
    greq:
      twitter.TwitterService/CreateUser:
        message: {"screen_name":""}
    test: |
      compare(current.res.message, "screen name is required")
      && current.res.status == 3
      && current.res.trailers["content-type"][0] == "application/grpc"

  - desc: 別のユーザーを作成してから重複エラーを確認
    greq:
      twitter.TwitterService/CreateUser:
        message: {"screen_name":"create_user_test", "user_name":"name", "bio":"bio"}
    test: |
      len(current.res.message.id) == 36
      && current.res.status == 0

  - desc: 登録済みのscreen_nameを指定するとエラーが返る
    greq:
      twitter.TwitterService/CreateUser:
        message: {"screen_name":"create_user_test", "user_name":"user_name", "bio":"bio"}
    test: |
      compare(current.res.message, "the screen name specified is already used")
      && current.res.status == 3
      && current.res.trailers["content-type"][0] == "application/grpc"
